<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>泉の花 業務管理 (IndexedDB版)</title>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --card: #fff; --danger: #dc3545; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: #333; line-height: 1.5; padding-bottom: 60px; }
        
        .tab-menu { display: flex; background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-item { flex: 1; padding: 15px 0; text-align: center; font-weight: bold; color: #666; cursor: pointer; border-bottom: 4px solid transparent; font-size: 1rem; }
        .tab-item.active { color: var(--primary); border-bottom: 4px solid var(--primary); }
        
        .container { padding: 12px; max-width: 800px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px; font-size: 1.2rem; }
        
        label { display: block; font-weight: bold; font-size: 0.85rem; margin-top: 12px; color: #555; }
        select, input, textarea { width: 100%; padding: 14px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; background: #fafafa; }
        
        .main-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 10px; }
        
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; z-index: 1000; display: none; white-space: nowrap; }

        .schedule-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #ddd; max-height: 70vh; overflow-y: auto; }
        .schedule-table { border-collapse: collapse; min-width: 600px; width: 100%; table-layout: fixed; }
        .schedule-table th, .schedule-table td { border: 1px solid #eee; padding: 4px 2px; text-align: center; font-size: 10px; height: 22px; }
        .schedule-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; font-size: 12px; }
        .time-col { width: 70px; background: #f8f9fa; font-weight: bold; position: sticky; left: 0; z-index: 5; }
        .booked { background: #e7f3ff; color: #004085; font-weight: bold; border-left: 3px solid var(--primary); }

        table.record-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .record-table th, .record-table td { border: 1px solid #eee; padding: 10px 4px; text-align: center; font-size: 0.85rem; }
        .salary-col { color: #e67700; font-weight: bold; }
        .staff-badge { display: inline-block; background: #333; color: #fff; padding: 2px 5px; border-radius: 3px; font-weight: bold; font-size: 0.75rem; }
        
        .btn-group { display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .edit-btn { background: #fab005; color: white; border: none; padding: 6px 0; border-radius: 4px; font-size: 10px; width: 45px; font-weight: bold; }
        .delete-btn { background: var(--danger); color: white; border: none; padding: 6px 0; border-radius: 4px; font-size: 10px; width: 45px; font-weight: bold; }
        .confirm-delete { background: #000 !important; width: 60px !important; }
        .staff-edit-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="tab-menu">
    <div class="tab-item active" onclick="switchTab('main')">入力・記録</div>
    <div class="tab-item" onclick="switchTab('schedule')">予定</div>
    <div class="tab-item" onclick="switchTab('report')">帳票</div>
    <div class="tab-item" onclick="switchTab('config')">設定</div>
</div>

<div class="container">
    <div id="main-tab" class="tab-content active">
        <div class="card">
            <h3>泉の花 入力</h3>
            <label>実施日</label><input type="date" id="date">
            <label>担当者</label><select id="staffSelect"></select>
            <label>コース</label><select id="itemSelect"></select>
            <label>開始時間</label><input type="time" id="startTime">
            <button class="main-btn" onclick="addData()">保存する</button>
        </div>
        <div class="card">
            <h3>今日の記録</h3>
            <div id="tableContainer"></div>
        </div>
    </div>

    <div id="schedule-tab" class="tab-content">
        <div class="card">
            <h3>タイムスケジュール</h3>
            <input type="date" id="scheduleDate" onchange="drawSchedule()">
            <div class="schedule-container" id="scheduleWrapper"></div>
        </div>
    </div>

    <div id="report-tab" class="tab-content">
        <div class="card">
            <h3>月次レポート</h3>
            <input type="month" id="reportMonth">
            <button class="main-btn" onclick="generateReport()" style="background:#17a2b8;">テキスト作成</button>
            <textarea id="reportOutput" style="background:#333; color:#0f0; font-family:monospace; height:200px; width:100%; margin-top:10px; padding:10px;" readonly></textarea>
            <button class="main-btn" onclick="copyReport()" style="background:#6c757d;">コピー</button>
        </div>
    </div>

    <div id="config-tab" class="tab-content">
        <div class="card">
            <h3>担当者歩合設定 (%)</h3>
            <div id="staffConfigList"></div>
        </div>
    </div>
</div>

<script>
    // --- IndexedDB 管理クラス ---
    const DB_NAME = 'IzumiFlowerDB';
    const DB_VERSION = 1;
    let db;

    const initDB = () => {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('records')) db.createObjectStore('records', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
            };
            request.onsuccess = (e) => { db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e);
        });
    };

    const saveData = (storeName, data) => {
        const tx = db.transaction(storeName, 'readwrite');
        tx.objectStore(storeName).put(data);
    };

    const getAllData = (storeName) => {
        return new Promise((resolve) => {
            const tx = db.transaction(storeName, 'readonly');
            const request = tx.objectStore(storeName).getAll();
            request.onsuccess = () => resolve(request.result);
        });
    };

    const deleteFromDB = (storeName, id) => {
        db.transaction(storeName, 'readwrite').objectStore(storeName).delete(id);
    };

    // --- アプリ基本設定 ---
    const defS = [{ name: "美和", rate: 100 }, { name: "翁", rate: 50 }, { name: "郭", rate: 50 }];
    const defC = [
        { name: "組合70分(A)", price: 8000, min: 70 },
        { name: "組合70分(B)", price: 9000, min: 70 },
        { name: "整体 60分", price: 5500, min: 60 },
        { name: "アロマ 60分", price: 8000, min: 60 }
    ];

    window.onload = async () => {
        await initDB();
        const now = new Date();
        document.getElementById('date').valueAsDate = now;
        document.getElementById('scheduleDate').valueAsDate = now;
        document.getElementById('reportMonth').value = now.toISOString().substring(0, 7);
        document.getElementById('startTime').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        refresh();
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 2500);
    }

    async function addData() {
        const d = document.getElementById('date').value;
        const sSel = document.getElementById('staffSelect');
        const sName = sSel.value;
        const sRate = parseInt(sSel.options[sSel.selectedIndex].getAttribute('data-rate'));
        const cSel = document.getElementById('itemSelect');
        const opt = cSel.options[cSel.selectedIndex];
        if(!opt.value) return showToast("コースを選択してください");

        const price = parseInt(opt.getAttribute('data-price'));
        const duration = parseInt(opt.getAttribute('data-min'));
        let finalStart = document.getElementById('startTime').value;
        const records = await getAllData('records');

        let adjusted = false;
        while (true) {
            const conflict = records.find(r => r.date === d && r.staff === sName && ((finalStart >= r.startTime && finalStart < r.endTime) || (calculateEndTime(finalStart, duration) > r.startTime && calculateEndTime(finalStart, duration) <= r.endTime)));
            if (!conflict) break;
            finalStart = conflict.endTime;
            adjusted = true;
        }

        const rec = { id: Date.now(), date: d, staff: sName, name: opt.value, price: price, salary: Math.floor(price * (sRate / 100)), startTime: finalStart, endTime: calculateEndTime(finalStart, duration) };
        saveData('records', rec);
        displayData();
        showToast(adjusted ? `${finalStart} にずらして保存しました` : "保存しました");
    }

    function calculateEndTime(start, min) {
        const [h, m] = start.split(':').map(Number);
        const total = h * 60 + m + min;
        return `${Math.floor(total / 60).toString().padStart(2, '0')}:${(total % 60).toString().padStart(2, '0')}`;
    }

    async function displayData() {
        const date = document.getElementById('date').value;
        const all = await getAllData('records');
        const data = all.filter(d => d.date === date).sort((a,b)=>a.startTime.localeCompare(b.startTime));
        const container = document.getElementById('tableContainer');
        if(data.length === 0) { container.innerHTML = "<p style='font-size:12px;color:gray;text-align:center;'>記録なし</p>"; return; }
        
        let htm = `<table class="record-table"><tr><th width="18%">時間</th><th width="35%">内容</th><th width="18%">売上</th><th width="18%">給与</th><th width="11%"></th></tr>`;
        data.forEach(d => {
            htm += `<tr>
                <td style="font-size:11px;">${d.startTime}<br>~${d.endTime}</td>
                <td style="text-align:left"><span class="staff-badge">${d.staff}</span><br><span style="font-size:10px">${d.name}</span></td>
                <td>${d.price}</td><td class="salary-col">${d.salary}</td>
                <td><div class="btn-group">
                    <button class="edit-btn" onclick="editSalary(${d.id})">修正</button>
                    <button class="delete-btn" onclick="confirmDelete(this, ${d.id})">削除</button>
                </div></td></tr>`;
        });
        container.innerHTML = htm + `</table>`;
    }

    async function confirmDelete(btn, id) {
        if (btn.classList.contains('confirm-delete')) {
            deleteFromDB('records', id);
            displayData();
            showToast("削除しました");
        } else {
            btn.innerText = "確定？";
            btn.classList.add('confirm-delete');
            setTimeout(() => { btn.innerText = "削除"; btn.classList.remove('confirm-delete'); }, 3000);
        }
    }

    async function editSalary(id) {
        const all = await getAllData('records');
        const rec = all.find(r => r.id === id);
        const val = prompt("給与額入力", rec.salary);
        if(val !== null) {
            rec.salary = parseInt(val);
            saveData('records', rec);
            displayData();
            showToast("修正しました");
        }
    }

    async function drawSchedule() {
        const date = document.getElementById('scheduleDate').value;
        const settings = await getAllData('settings');
        const sList = settings.find(s => s.key === 'staffList')?.value || defS;
        const all = await getAllData('records');
        const records = all.filter(r => r.date === date);
        const wrapper = document.getElementById('scheduleWrapper');
        let html = `<table class="schedule-table"><thead><tr><th class="time-col">時間</th>`;
        sList.forEach(s => html += `<th>${s.name}</th>`);
        html += `</tr></thead><tbody>`;
        for (let h = 10; h < 24; h++) {
            for (let m = 0; m < 60; m += 5) {
                const t = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                html += `<tr><td class="time-col">${t}</td>`;
                sList.forEach(s => {
                    const b = records.find(r => r.staff === s.name && t >= r.startTime && t < r.endTime);
                    html += b ? `<td class="booked">${t === b.startTime ? b.name.substring(0,5) : ''}</td>` : `<td></td>`;
                });
                html += `</tr>`;
            }
        }
        wrapper.innerHTML = html + `</tbody></table>`;
    }

    async function refresh() {
        const settings = await getAllData('settings');
        const sList = settings.find(s => s.key === 'staffList')?.value || defS;
        document.getElementById('staffSelect').innerHTML = sList.map(s => `<option value="${s.name}" data-rate="${s.rate}">${s.name}(${s.rate}%)</option>`).join('');
        document.getElementById('itemSelect').innerHTML = '<option value="">-- 選択 --</option>' + defC.map(c => `<option value="${c.name}" data-price="${c.price}" data-min="${c.min}">${c.name}(${c.price}円)</option>`).join('');
        document.getElementById('staffConfigList').innerHTML = sList.map((s, i) => `<div class="staff-edit-row"><b>${s.name}</b> <input type="number" style="width:50px" value="${s.rate}" onchange="updateStaffRate(${i}, this.value)"> %</div>`).join('');
        displayData();
    }

    async function updateStaffRate(i, r) {
        const settings = await getAllData('settings');
        let sList = settings.find(s => s.key === 'staffList')?.value || defS;
        sList[i].rate = parseInt(r);
        saveData('settings', { key: 'staffList', value: sList });
        showToast("歩合を変更しました");
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-item').forEach((el, i) => el.classList.toggle('active', ['main','schedule','report','config'][i] === t));
        document.querySelectorAll('.tab-content').forEach((el, i) => el.classList.toggle('active', ['main','schedule','report','config'][i] === t));
        if(t === 'schedule') drawSchedule();
    }

    async function generateReport() {
        const m = document.getElementById('reportMonth').value;
        const all = await getAllData('records');
        const d = all.filter(x => x.date.startsWith(m)).sort((a,b)=>a.date.localeCompare(b.date));
        let res = `【${m}】\n`, tP = 0, tS = 0;
        d.forEach(x => { res += `${x.date.substring(8)}日 ${x.staff} 売:${x.price} 給:${x.salary}\n`; tP += x.price; tS += x.salary; });
        res += `合計 売上:${tP} / 給料:${tS}`;
        document.getElementById('reportOutput').value = res;
    }
    function copyReport() { const o = document.getElementById('reportOutput'); o.select(); document.execCommand('copy'); showToast("コピーしました"); }
</script>
</body>
</html>
